# Project Plan: CLI Database Tool Integration

This project adds a new CLI utility within this repository to manage PostgreSQL databases. The CLI lives in `dbtool.go` and is guarded by the build tag `dbtool` to avoid conflicting with the existing `env-anonymizer` main package.

## Objectives

- Provide commands to list, dump, import, reset databases, and run ad-hoc SQL queries.
- Keep existing binaries unaffected by default `go build`.

## Build/Run

- Build default repo (env-anonymizer only):
  - `go build ./...`

- Run dbtool directly:
  - `go run -tags dbtool dbtool.go <command> ...`

- Build a dbtool binary:
  - `go build -tags dbtool -o dbtool dbtool.go`

## Commands

- `database list` (aliases: `db list`, `db ls`)
  - Lists non-template databases.

- `database dump <dbname> <filepath> [--structure-only]` (aliases: `db dump`, `db export`)
  - Dumps database to a file using `pg_dump`.
  - Use `--structure-only` to dump schema only.

- `database import <dbname> <filepath> [--overwrite]` (aliases: `db import`, `db load`)
  - Imports SQL from a file using `psql -f`.
  - Use `--overwrite` to reset schema first.

- `database reset <dbname> [--noconfirm]` (aliases: `db reset`, `db wipe`)
  - Drops and recreates the `public` schema.
  - Confirmation required unless `--noconfirm`.

- `query <dbname> --query="<sql>" [--json]` (alias: `q`)
  - Runs a SQL statement.
  - If `SELECT`, prints rows; `--json` outputs JSON.
  - If non-`SELECT`, executes and prints `OK` on success.

- `help [command] [subcommand]`
  - Shows summary or detailed usage, e.g., `help database dump`, `help q`.

## Configuration

`dbtool.go` loads Postgres connection info from:
`~/.config/<current-folder-name>/config.ini` in section `[default]` with keys:
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_SSLMODE`, `DB_MIGRATIONS_DIR`

Defaults:
- `DB_SSLMODE=disabled` if not set
- `DB_PORT=5432` if not set

## External Dependencies

- Requires `pg_dump` and `psql` available on PATH for dump/import.

## Next Steps

- Add nicer tabular output for `query` when not JSON.
- Optional flags for `dump`/`import` to control format (custom, directory).
- Unit tests for helper functions (where feasible without live DB).
