# Project Plan: CLI Database Tool Integration

This project adds a new CLI utility within this repository to manage PostgreSQL databases. The CLI lives in `dbtool.go` and is guarded by the build tag `dbtool` to avoid conflicting with the existing `env-anonymizer` main package.

## Objectives

- Provide commands to list, dump, import, reset databases, and run ad-hoc SQL queries.
- Keep existing binaries unaffected by default `go build`.

## Build/Run

- Build default repo (env-anonymizer only):
  - `go build ./...`

- Run dbtool directly:
  - `go run -tags dbtool dbtool.go <command> ...`

- Build a dbtool binary:
  - `go build -tags dbtool -o dbtool dbtool.go`

### Verbose diagnostics

- Use `-v` or `--verbose` as a global flag to print diagnostics about configuration resolution.
- When enabled:
  - `dbtool.go` prints which `.env` files were found and applied, and how `DBTOOL_CONFIG_FILE` is resolved when relative.
  - `utility/dbtool/database.go` prints which `config.ini` path is used and when it is read.
  - `usage()` shows a Global flags section.

## Commands

- `database list` (aliases: `db list`, `db ls`)
  - Lists non-template databases.

- `database dump <dbname> <filepath> [--structure-only]` (aliases: `db dump`, `db export`)
  - Dumps database to a file using `pg_dump`.
  - Use `--structure-only` to dump schema only.

- `database import <dbname> <filepath> [--overwrite]` (aliases: `db import`, `db load`)
  - Imports SQL from a file using `psql -f`.
  - Use `--overwrite` to reset schema first.

- `database reset <dbname> [--noconfirm]` (aliases: `db reset`, `db wipe`)
  - Drops and recreates the `public` schema.
  - Confirmation required unless `--noconfirm`.

- `table list [<dbname>] [--schema=<schema>]` (aliases: `tables list`, `tables ls`)
  - Lists tables from `information_schema.tables`.
  - If no schema is provided, excludes system schemas (`pg_catalog`, `information_schema`).
  - `<dbname>` is optional; if omitted, defaults to `DB_NAME` or the database name parsed from `DATABASE_URL`.

- `query <dbname> --query="<sql>" [--json]` (alias: `q`)
  - Runs a SQL statement.
  - If `SELECT`, prints rows; `--json` outputs JSON.
  - If non-`SELECT`, executes and prints `OK` on success.

- `help [command] [subcommand]`
  - Shows summary or detailed usage, e.g., `help database dump`, `help q`.

## Configuration

`dbtool.go` loads Postgres connection info from:
`~/.config/<current-folder-name>/config.ini` in section `[default]` with keys:
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_SSLMODE`, `DB_MIGRATIONS_DIR`
- `DATABASE_URL` (optional DSN). If provided (e.g., `postgres://...`), it takes precedence over the discrete fields above.

Environment variables are also read as fallback for each key (e.g., `DB_HOST`, `DB_PORT`, and `DATABASE_URL`).

Defaults:
- `DB_SSLMODE=disabled` if not set
- `DB_PORT=5432` if not set

Xata support:
- If `DATABASE_URL` is set to a Xata HTTPS workspace URL (e.g., `https://<workspace>.xata.sh/db/<db>`), the tool will return a helpful error. Use Xata's PostgreSQL-compatible DSN instead (e.g., `postgres://...`) for connections, dumps, and imports.

## External Dependencies

- Requires `pg_dump` and `psql` available on PATH for dump/import.

## Next Steps

- Add nicer tabular output for `query` when not JSON.
- Optional flags for `dump`/`import` to control format (custom, directory).
- Add first-class helper to transform Xata HTTPS URL to its Postgres DSN (if/when Xata provides a deterministic mapping or via API).
- Unit tests for helper functions (where feasible without live DB).
